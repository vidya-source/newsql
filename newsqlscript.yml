---
- name: MySQL Health Check Playbook
  hosts: localhost
  gather_facts: no
  become: no
  vars:
    mysql_host: "localhost"
    mysql_port: "3306"
    mysql_user: "mysqlauto"
    mysql_password: "mysqlAutomation"
    possible_mysql_paths:
      - /usr/bin/mysql
      - /usr/local/bin/mysql
      - /usr/local/mysql/bin/mysql
      - mysql
  
  tasks:
    - name: Find MySQL client
      shell: "which mysql || echo ''"
      register: mysql_path
      ignore_errors: yes

    - name: Set MySQL command
      set_fact:
        mysql_cmd: "{{ mysql_path.stdout if mysql_path.stdout != '' else 'mysql' }} -h{{ mysql_host }} -P{{ mysql_port }} -u{{ mysql_user }} -p{{ mysql_password }} -N -B"

    - name: Create timestamp
      set_fact:
        timestamp: "{{ lookup('pipe', 'date +%Y-%m-%d_%H-%M-%S') }}"

    - name: Test MySQL Connection
      shell: "{{ mysql_cmd }} -e 'SELECT VERSION();'"
      register: mysql_version
      ignore_errors: yes

    - name: Get Database Sizes
      shell: |
        {{ mysql_cmd }} -e "
        SELECT CONCAT(table_schema, ',', 
          ROUND(SUM(data_length + index_length) / 1024 / 1024, 2)) 
        FROM information_schema.tables 
        GROUP BY table_schema;"
      register: db_sizes
      when: mysql_version.rc == 0
      ignore_errors: yes

    - name: Get Running Processes
      shell: |
        {{ mysql_cmd }} -e "
        SELECT CONCAT(id, ',', user, ',', db, ',', time, ',', state) 
        FROM information_schema.processlist
        WHERE command != 'Sleep';"
      register: process_list
      when: mysql_version.rc == 0
      ignore_errors: yes

    - name: Get Server Status
      shell: |
        {{ mysql_cmd }} -e "
        SHOW GLOBAL STATUS WHERE Variable_name IN 
        ('Threads_connected', 'Threads_running', 'Questions', 'Uptime');"
      register: server_status
      when: mysql_version.rc == 0
      ignore_errors: yes

    - name: Get Table Status
      shell: |
        {{ mysql_cmd }} -e "
        SELECT CONCAT(table_schema, ',', table_name, ',', 
          engine, ',', IFNULL(table_rows, 'N/A'), ',',
          ROUND(data_length/1024/1024, 2))
        FROM information_schema.tables 
        WHERE table_schema NOT IN ('information_schema', 'performance_schema', 'mysql')
        ORDER BY data_length DESC LIMIT 10;"
      register: table_status
      when: mysql_version.rc == 0
      ignore_errors: yes

    - name: Create Report Directory
      file:
        path: "./mysql_reports"
        state: directory
        mode: '0755'

    - name: Generate Health Report
      copy:
        content: |
          MySQL Health Report - {{ timestamp }}
          ================================================

          Connection Information
          ---------------------
          Host: {{ mysql_host }}
          Port: {{ mysql_port }}
          MySQL Version: {{ mysql_version.stdout if mysql_version.rc == 0 else 'Connection Failed' }}
          MySQL Client Path: {{ mysql_path.stdout if mysql_path.stdout != '' else 'Using default PATH' }}

          Database Space Utilization
          -------------------------
          {% if db_sizes.rc == 0 and db_sizes.stdout_lines | length > 0 %}
          {% for line in db_sizes.stdout_lines %}
          {% set parts = line.split(',') %}
          Database: {{ parts[0] }}
          Size (MB): {{ parts[1] }}
          {% endfor %}
          {% else %}
          Failed to get database sizes
          Error: {{ db_sizes.stderr if db_sizes.stderr is defined else 'Unknown error' }}
          {% endif %}

          Top 10 Largest Tables
          --------------------
          {% if table_status.rc == 0 and table_status.stdout_lines | length > 0 %}
          {% for line in table_status.stdout_lines %}
          {% set parts = line.split(',') %}
          Schema: {{ parts[0] }}
          Table: {{ parts[1] }}
          Engine: {{ parts[2] }}
          Rows: {{ parts[3] }}
          Size (MB): {{ parts[4] }}
          {% endfor %}
          {% else %}
          Failed to get table status
          Error: {{ table_status.stderr if table_status.stderr is defined else 'Unknown error' }}
          {% endif %}

          Running Processes
          ----------------
          {% if process_list.rc == 0 and process_list.stdout_lines | length > 0 %}
          {% for line in process_list.stdout_lines %}
          {% set parts = line.split(',') %}
          ID: {{ parts[0] }}
          User: {{ parts[1] }}
          Database: {{ parts[2] }}
          Time: {{ parts[3] }}
          State: {{ parts[4] }}
          {% endfor %}
          {% else %}
          No active processes or failed to get process list
          Error: {{ process_list.stderr if process_list.stderr is defined else 'Unknown error' }}
          {% endif %}

          Server Status
          -------------
          {% if server_status.rc == 0 and server_status.stdout_lines | length > 0 %}
          {{ server_status.stdout }}
          {% else %}
          Failed to get server status
          Error: {{ server_status.stderr if server_status.stderr is defined else 'Unknown error' }}
          {% endif %}
        dest: "./mysql_reports/mysql_health_report_{{ timestamp }}.txt"
        mode: '0644'

    - name: Display Report Location
      debug:
        msg: "MySQL health report has been generated at ./mysql_reports/mysql_health_report_{{ timestamp }}.txt"
