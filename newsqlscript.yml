- name: Check MySQL Server Health
  hosts: localhost
  gather_facts: no
  vars:
    ansible_python_interpreter: /usr/bin/python3
    mysql_host: "10.112.0.10"
    mysql_user: "mysqlauto"
    mysql_password: "mysqlAutomation"
    mysql_port: 3306
 
  tasks:
    - name: Ensure required packages are installed
      package:
        name: 
          - jq
          - mysql-client
        state: present
      become: yes
 
    - name: Get Database Space Utilization
      shell: |
        query="SELECT table_schema AS DatabaseName,
                      ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS SizeMB
               FROM information_schema.tables
               GROUP BY table_schema;"
        mysql -h {{ mysql_host }} -u {{ mysql_user }} -p{{ mysql_password }} -P {{ mysql_port }} -e "$query" --silent --skip-column-names | awk '{print "{\"DatabaseName\": \""$1"\", \"SizeMB\": "$2"}"}' | jq -s '.'
      register: db_space
      ignore_errors: yes
 
    - name: Get Database Health
      shell: |
        query="SELECT schema_name AS DatabaseName,
                      IF(SUM(data_free) > 0, 'Unhealthy', 'Healthy') AS Status,
                      COUNT(*) AS ActiveConnections
               FROM information_schema.schemata
               LEFT JOIN information_schema.processlist ON processlist.db = schemata.schema_name
               GROUP BY schema_name;"
        mysql -h {{ mysql_host }} -u {{ mysql_user }} -p{{ mysql_password }} -P {{ mysql_port }} -e "$query" --silent --skip-column-names | awk '{print "{\"DatabaseName\": \""$1"\", \"Status\": \""$2"\", \"ActiveConnections\": "$3"}"}' | jq -s '.'
      register: db_health
      ignore_errors: yes
 
    - name: Check for Deadlocks
      shell: |
        mysql -h {{ mysql_host }} -u {{ mysql_user }} -p{{ mysql_password }} -P {{ mysql_port }} -e "SHOW ENGINE INNODB STATUS;" --silent | grep -i 'deadlock' || echo "No Deadlocks"
      register: deadlocks
      ignore_errors: yes
 
    - name: Get MySQL Job Activities
      shell: |
        mysql -h {{ mysql_host }} -u {{ mysql_user }} -p{{ mysql_password }} -P {{ mysql_port }} -e "SHOW EVENTS;" --silent --skip-column-names | awk '{print "{\"Event\": \""$1"\", \"Status\": \""$2"\"}"}' | jq -s '.'
      register: job_activities
      ignore_errors: yes
 
    - name: Convert Outputs to JSON
      set_fact:
        db_space_fact: "{{ db_space.stdout | from_json if db_space.stdout is not none else [] }}"
        db_health_fact: "{{ db_health.stdout | from_json if db_health.stdout is not none else [] }}"
        deadlocks_fact: "{{ {'Deadlocks': 1} if 'Deadlock' in deadlocks.stdout else {'Deadlocks': 0} }}"
        job_activities_fact: "{{ job_activities.stdout | from_json if job_activities.stdout is not none else [] }}"
 
    - name: Display Formatted Results
      debug:
        msg: |
          📊 Database Space Utilization:
          {% for item in db_space_fact %}
           - {{ item.DatabaseName }}: {{ item.SizeMB }} MB
          {% endfor %}
          🚨 Deadlocks:
          {% if deadlocks_fact.Deadlocks > 0 %}
           - Deadlocks detected!
          {% else %}
           - No deadlocks detected
          {% endif %}
          🛠 MySQL Job Activities:
          {% if job_activities_fact | length > 0 %}
            {% for item in job_activities_fact %}
               - Event: {{ item.Event }}
                 - Status: {{ item.Status }}
            {% endfor %}
          {% else %}
            [❌] No events found.
          {% endif %}
          🩺 Database Health Check:
          {% if db_health_fact | length > 0 %}
            {% for item in db_health_fact %}
               - Database: {{ item.DatabaseName }}
                 - Status: {{ item.Status }}
                 - Active Connections: {{ item.ActiveConnections }}
            {% endfor %}
          {% else %}
            [❌] No database health data available.
          {% endif %}
